<!doctype html>
<html lang="en" ng-app="myApp">
    <head>
        <meta charset="UTF-8" />
        <title>TAPI</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
    </head>
    <body ng-controller="MainController">
        <div ng-show="!isLoggedIn">
            <button ng-click="switchView('register')">Register</button>
            <button ng-click="switchView('login')">Login</button>
        </div>
        <div ng-show="isLoggedIn">
            <button ng-click="switchView('createPost')">Create Post</button>
            <button ng-click="logout()">Logout</button>
        </div>

        <!-- Register -->
        <div ng-show="currentView === 'register'">
            <h2>Register</h2>
            <form ng-submit="register()">
                <input
                    type="email"
                    ng-model="user.email"
                    placeholder="Email"
                    required
                />
                <input
                    type="text"
                    ng-model="user.name"
                    placeholder="Name"
                    required
                />
                <input
                    type="password"
                    ng-model="user.password"
                    placeholder="Password"
                    required
                />
                <input
                    type="password"
                    ng-model="user.passwordConfirm"
                    placeholder="Confirm Password"
                    required
                />
                <button type="submit">Register</button>
            </form>
        </div>

        <!-- Login -->
        <div ng-show="currentView === 'login'">
            <h2>Login</h2>
            <form ng-submit="login()">
                <input
                    type="email"
                    ng-model="loginUser.email"
                    placeholder="Email"
                    required
                />
                <input
                    type="password"
                    ng-model="loginUser.password"
                    placeholder="Password"
                    required
                />
                <button type="submit">Login</button>
            </form>
        </div>

        <!-- Create Post -->
        <div ng-show="currentView === 'createPost'">
            <h2>Create Post</h2>
            <form ng-submit="createPost()">
                <input
                    type="text"
                    ng-model="post.title"
                    placeholder="Title"
                    required
                />
                <textarea
                    ng-model="post.content"
                    placeholder="Content"
                    required
                ></textarea>
                <input
                    type="text"
                    ng-model="post.image"
                    placeholder="Image URL"
                />
                <button type="submit">Create</button>
            </form>
        </div>

        <!-- View Posts -->
        <div ng-show="currentView === 'viewPosts'">
            <h2>Posts</h2>
            <div ng-repeat="post in posts">
                <h3>{{post.title}}</h3>
                <p>{{post.content}}</p>
                <img ng-src="{{post.image}}" alt="Post image" />
                <p>Created: {{post.created_at | date:'medium'}}</p>
                <button ng-click="editPost(post)">Edit</button>
                <button ng-click="deletePost(post.id)">Delete</button>
                <div ng-repeat="comment in post.comments">
                    <p>{{comment.content}}</p>
                </div>
            </div>
            <button
                ng-click="changePage(currentPage - 1)"
                ng-disabled="currentPage === 1"
            >
                Previous
            </button>
            <span>Page {{currentPage}} of {{totalPages}}</span>
            <button
                ng-click="changePage(currentPage + 1)"
                ng-disabled="currentPage === totalPages"
            >
                Next
            </button>
        </div>

        <!-- Edit Post -->
        <div ng-show="currentView === 'editPost'">
            <h2>Edit Post</h2>
            <form ng-submit="updatePost()">
                <input
                    type="text"
                    ng-model="editingPost.title"
                    placeholder="Title"
                    required
                />
                <textarea
                    ng-model="editingPost.content"
                    placeholder="Content"
                    required
                ></textarea>
                <input
                    type="text"
                    ng-model="editingPost.image"
                    placeholder="Image URL"
                />
                <button type="submit">Update</button>
                <button type="button" ng-click="cancelEdit()">Cancel</button>
            </form>
        </div>

        <p ng-if="error">{{error}}</p>
        <p ng-if="success">{{success}}</p>

        <script>
            angular
                .module("myApp", [])
                .controller("MainController", function ($scope, $http) {
                    $scope.currentView = "register";
                    $scope.user = {};
                    $scope.loginUser = {};
                    $scope.post = { image: "default.png" };
                    $scope.jwt = "";
                    $scope.isLoggedIn = false;
                    $scope.posts = [];
                    $scope.currentPage = 1;
                    $scope.totalPages = 1;

                    $scope.switchView = function (view) {
                        $scope.currentView = view;
                        $scope.error = null;
                        $scope.success = null;
                        if (view === "viewPosts") $scope.fetchPosts();
                    };

                    $scope.register = function () {
                        if (
                            $scope.user.password !== $scope.user.passwordConfirm
                        ) {
                            $scope.error = "Passwords do not match";
                            return;
                        }
                        $http.post("/api/auth/register", $scope.user).then(
                            function (response) {
                                $scope.jwt = response.data.token;
                                $scope.isLoggedIn = true;
                                $scope.switchView("login");
                                $scope.success = "Registration successful!";
                            },
                            function (error) {
                                $scope.error =
                                    "Registration failed: " + error.data;
                            },
                        );
                    };

                    $scope.login = function () {
                        $http.post("/api/auth/login", $scope.loginUser).then(
                            function (response) {
                                $scope.jwt = response.data.access_token;
                                $scope.isLoggedIn = true;
                                $scope.switchView("viewPosts");
                                $scope.success = "Login successful!";
                            },
                            function (error) {
                                $scope.error = "Login failed: " + error.data;
                            },
                        );
                    };

                    $scope.logout = function () {
                        $scope.jwt = "";
                        $scope.isLoggedIn = false;
                        $scope.switchView("login");
                    };

                    $scope.createPost = function () {
                        $http.post("/api/posts", $scope.post).then(
                            function () {
                                $scope.post = { image: "default.png" };
                                $scope.switchView("viewPosts");
                            },
                            function (error) {
                                $scope.error =
                                    "Failed to create post: " + error.data;
                            },
                        );
                    };

                    $scope.fetchPosts = function () {
                        $http
                            .get("/api/posts", {
                                params: { page: $scope.currentPage, limit: 10 },
                            })
                            .then(
                                function (response) {
                                    $scope.posts = response.data.data;
                                    $scope.totalPages = Math.ceil(
                                        response.data.results / 10,
                                    );
                                },
                                function (error) {
                                    $scope.error =
                                        "Failed to fetch posts: " + error.data;
                                },
                            );
                    };

                    $scope.changePage = function (newPage) {
                        if (newPage >= 1 && newPage <= $scope.totalPages) {
                            $scope.currentPage = newPage;
                            $scope.fetchPosts();
                        }
                    };

                    $scope.deletePost = function (postId) {
                        if (confirm("Delete this post?")) {
                            $http.delete("/api/posts/" + postId).then(
                                function () {
                                    $scope.fetchPosts();
                                },
                                function (error) {
                                    $scope.error =
                                        "Failed to delete post: " + error.data;
                                },
                            );
                        }
                    };

                    $scope.editPost = function (post) {
                        $scope.editingPost = angular.copy(post);
                        $scope.currentView = "editPost";
                    };

                    $scope.updatePost = function () {
                        $http
                            .put(
                                "/api/posts/" + $scope.editingPost.id,
                                $scope.editingPost,
                            )
                            .then(
                                function () {
                                    $scope.switchView("viewPosts");
                                },
                                function (error) {
                                    $scope.error =
                                        "Failed to update post: " + error.data;
                                },
                            );
                    };

                    $scope.cancelEdit = function () {
                        $scope.editingPost = null;
                        $scope.currentView = "viewPosts";
                    };
                });
        </script>
    </body>
</html>
